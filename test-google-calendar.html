<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Google Calendar API</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      #log {
        background: #f8f9fa;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Test Google Calendar API</h1>

    <div class="status info">
      <strong>Cliente ID configurado:</strong>
      1097397293263-t7jntqr4tsp4np34f63os3221d4c7qkp.apps.googleusercontent.com
    </div>

    <div id="status" class="status">Estado: Inicializando...</div>

    <div>
      <button id="checkBtn" onclick="checkConfiguration()">
        0. Verificar Configuraci√≥n
      </button>
      <button id="initBtn" onclick="initializeAPI()">1. Inicializar API</button>
      <button id="authBtn" onclick="authorize()" disabled>
        2. Conectar Calendar
      </button>
      <button id="testBtn" onclick="testCreateEvent()" disabled>
        3. Crear Evento de Prueba
      </button>
      <button id="signOutBtn" onclick="signOut()" disabled>
        4. Desconectar
      </button>
    </div>

    <h3>üìã Log de actividad:</h3>
    <div id="log"></div>

    <script>
      const CLIENT_ID =
        '1097397293263-t7jntqr4tsp4np34f63os3221d4c7qkp.apps.googleusercontent.com';
      const SCOPES = [
        'https://www.googleapis.com/auth/calendar',
        'https://www.googleapis.com/auth/calendar.events',
      ].join(' ');

      let isInitialized = false;
      let isSignedIn = false;

      function log(message) {
        const logDiv = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${time}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function updateStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        statusDiv.className = `status ${type}`;
        statusDiv.innerHTML = `<strong>Estado:</strong> ${message}`;
      }

      function updateButtons() {
        document.getElementById('checkBtn').disabled = false;
        document.getElementById('initBtn').disabled = isInitialized;
        document.getElementById('authBtn').disabled =
          !isInitialized || isSignedIn;
        document.getElementById('testBtn').disabled = !isSignedIn;
        document.getElementById('signOutBtn').disabled = !isSignedIn;
      }

      function checkConfiguration() {
        log('üîç Verificando configuraci√≥n...');

        // Verificar Client ID
        if (
          !CLIENT_ID ||
          CLIENT_ID === 'TU_CLIENT_ID_AQUI.apps.googleusercontent.com'
        ) {
          log('‚ùå Client ID no configurado correctamente');
          updateStatus('Error: Client ID no configurado', 'error');
          return;
        }

        log('‚úÖ Client ID configurado correctamente');
        log(`üìã Client ID: ${CLIENT_ID}`);

        // Verificar formato del Client ID
        if (!CLIENT_ID.endsWith('.apps.googleusercontent.com')) {
          log('‚ö†Ô∏è El Client ID no tiene el formato esperado');
          updateStatus('Advertencia: Formato de Client ID inusual', 'error');
          return;
        }

        log('‚úÖ Formato de Client ID correcto');

        // Verificar conectividad con Google
        log('üåê Verificando conectividad con Google APIs...');

        fetch('https://apis.google.com/js/api.js', { method: 'HEAD' })
          .then(response => {
            if (response.ok) {
              log('‚úÖ Conectividad con Google APIs: OK');
              updateStatus(
                'Configuraci√≥n verificada. Listo para inicializar API.',
                'success'
              );
            } else {
              log('‚ùå Problema de conectividad con Google APIs');
              updateStatus(
                'Error: No se puede conectar a Google APIs',
                'error'
              );
            }
          })
          .catch(error => {
            log('‚ùå Error de red al conectar con Google APIs');
            log(`üìã Error: ${error.message}`);
            updateStatus('Error: Problema de conexi√≥n a internet', 'error');
          });

        // Verificar URL actual
        const currentUrl = window.location.href;
        log(`üìç URL actual: ${currentUrl}`);

        if (currentUrl.includes('localhost:3000')) {
          log(
            '‚úÖ Ejecut√°ndose en localhost:3000 (configuraci√≥n de desarrollo)'
          );
          log('üìã IMPORTANTE: Verifica en Google Cloud Console que tengas:');
          log('   1. Proyecto seleccionado correctamente');
          log('   2. Google Calendar API habilitada');
          log('   3. Credenciales OAuth 2.0 con URIs autorizados:');
          log('      - http://localhost:3000');
          log('   4. Pantalla de consentimiento configurada');
        } else {
          log('‚ö†Ô∏è No se est√° ejecutando en localhost:3000');
          log(
            '‚ÑπÔ∏è Aseg√∫rate de que esta URL est√© en los URIs autorizados de Google Cloud Console'
          );
        }
      }

      async function initializeAPI() {
        try {
          log('üîÑ Inicializando Google Calendar API...');
          updateStatus('Cargando Google API...', 'info');

          // Verificar si gapi ya est√° cargado
          if (window.gapi) {
            log('‚ÑπÔ∏è Google API ya estaba cargada');
          } else {
            log('üì° Cargando Google API...');
            // Cargar Google API
            await new Promise((resolve, reject) => {
              const script = document.createElement('script');
              script.src = 'https://apis.google.com/js/api.js';
              script.onload = () => {
                log('‚úÖ Script de Google API cargado');
                resolve();
              };
              script.onerror = error => {
                log('‚ùå Error cargando script de Google API');
                reject(new Error('No se pudo cargar Google API'));
              };
              document.head.appendChild(script);
            });
          }

          log('üîÑ Cargando m√≥dulo auth2...');
          // Inicializar gapi
          await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
              reject(new Error('Timeout cargando auth2'));
            }, 10000);

            gapi.load('auth2', {
              callback: () => {
                clearTimeout(timeout);
                log('‚úÖ M√≥dulo auth2 cargado');
                resolve();
              },
              onerror: () => {
                clearTimeout(timeout);
                reject(new Error('Error cargando auth2'));
              },
            });
          });

          log('üîÑ Inicializando auth2...');
          // Inicializar auth2 con manejo de errores mejorado
          let authInstance;
          try {
            authInstance = await new Promise((resolve, reject) => {
              gapi.auth2
                .init({
                  client_id: CLIENT_ID,
                  scope: SCOPES,
                })
                .then(resolve, reject);
            });
            log('‚úÖ Auth2 inicializado correctamente');
          } catch (authError) {
            log(
              `‚ùå Error espec√≠fico en auth2: ${authError.error || authError.message || authError}`
            );
            if (authError.error === 'invalid_client') {
              log('üîß Soluci√≥n: Verifica el Client ID en Google Cloud Console');
              log(
                'üîß Aseg√∫rate de que http://localhost:3000 est√© en URIs autorizados'
              );
            }
            throw authError;
          }

          log('üîÑ Cargando m√≥dulo client...');
          // Cargar client
          await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
              reject(new Error('Timeout cargando client'));
            }, 10000);

            gapi.load('client', {
              callback: () => {
                clearTimeout(timeout);
                log('‚úÖ M√≥dulo client cargado');
                resolve();
              },
              onerror: () => {
                clearTimeout(timeout);
                reject(new Error('Error cargando client'));
              },
            });
          });

          log('üîÑ Inicializando client...');
          // Inicializar client
          await gapi.client.init({
            clientId: CLIENT_ID,
            scope: SCOPES,
            discoveryDocs: [
              'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            ],
          });

          log('‚úÖ Google Calendar API inicializada correctamente');
          log(`üìã Client ID: ${CLIENT_ID.substring(0, 20)}...`);

          isInitialized = true;
          updateStatus('API inicializada. Listo para conectar.', 'success');
          updateButtons();
        } catch (error) {
          log(`‚ùå Error inicializando API: ${error.message}`);
          log(`üìã Detalles del error: ${error.stack || 'Sin stack trace'}`);
          updateStatus(`Error: ${error.message}`, 'error');

          // Informaci√≥n adicional para debug
          log(`üîç window.gapi existe: ${!!window.gapi}`);
          if (window.gapi) {
            log(`üîç gapi.auth2 existe: ${!!window.gapi.auth2}`);
            log(`üîç gapi.client existe: ${!!window.gapi.client}`);
          }
        }
      }

      async function authorize() {
        try {
          log('üîÑ Solicitando autorizaci√≥n...');
          updateStatus('Solicitando permisos de Google Calendar...', 'info');

          const authInstance = gapi.auth2.getAuthInstance();
          const user = await authInstance.signIn();

          if (user.isSignedIn()) {
            isSignedIn = true;
            log('‚úÖ Usuario autenticado correctamente');
            log(`üë§ Usuario: ${user.getBasicProfile().getEmail()}`);
            updateStatus(
              `Conectado como: ${user.getBasicProfile().getEmail()}`,
              'success'
            );
            updateButtons();
          } else {
            throw new Error('Usuario no autorizado');
          }
        } catch (error) {
          log(`‚ùå Error en autorizaci√≥n: ${error.message}`);
          updateStatus(`Error de autorizaci√≥n: ${error.message}`, 'error');
        }
      }

      async function testCreateEvent() {
        try {
          log('üîÑ Creando evento de prueba...');
          updateStatus('Creando evento en Google Calendar...', 'info');

          const event = {
            summary: 'Evento de Prueba - EventPro',
            description:
              'Este es un evento de prueba creado desde EventPro para verificar la integraci√≥n con Google Calendar.',
            location: 'Buenos Aires, Argentina',
            start: {
              date: '2025-08-03', // Ma√±ana
              timeZone: 'America/Argentina/Buenos_Aires',
            },
            end: {
              date: '2025-08-03',
              timeZone: 'America/Argentina/Buenos_Aires',
            },
          };

          const response = await gapi.client.calendar.events.insert({
            calendarId: 'primary',
            resource: event,
          });

          log('‚úÖ Evento creado exitosamente');
          log(`üîó ID del evento: ${response.result.id}`);
          log(`üìÖ Verifica tu Google Calendar`);

          updateStatus(
            '¬°Evento creado! Verifica tu Google Calendar',
            'success'
          );
        } catch (error) {
          log(`‚ùå Error creando evento: ${error.message}`);
          updateStatus(`Error creando evento: ${error.message}`, 'error');
        }
      }

      async function signOut() {
        try {
          const authInstance = gapi.auth2.getAuthInstance();
          await authInstance.signOut();

          isSignedIn = false;
          log('‚úÖ Sesi√≥n cerrada');
          updateStatus('Desconectado de Google Calendar', 'info');
          updateButtons();
        } catch (error) {
          log(`‚ùå Error cerrando sesi√≥n: ${error.message}`);
        }
      }

      // Inicializar al cargar la p√°gina
      window.onload = () => {
        log('üöÄ Test de Google Calendar API iniciado');
        updateStatus(
          'Listo para probar. Haz clic en "Inicializar API"',
          'info'
        );
        updateButtons();
      };
    </script>
  </body>
</html>
